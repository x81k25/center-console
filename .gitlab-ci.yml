workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

stages:
  - test
  - build
  - deploy-test

variables:
  IMAGE: "${CI_REGISTRY_IMAGE}"

# Test stage - runs on MR only
# Basic syntax validation since no test framework exists
test:
  stage: test
  tags:
    - k8s
    - docker
  image: docker.io/astral/uv:python3.12-bookworm-slim
  before_script:
    - uv sync
  script:
    # Validate Python syntax and imports
    - uv run python -m py_compile app.py
    - uv run python -c "import app; print('Import successful')"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build stage - runs on push to dev/stg/main
build:
  stage: build
  tags:
    - k8s
    - docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${IMAGE}:${CI_COMMIT_REF_NAME}"
      --destination "${IMAGE}:sha-${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

# Deploy-test template
.deploy-test:
  stage: deploy-test
  tags:
    - k8s
    - docker
  image: alpine/k8s:1.28.3
  needs:
    - build
  variables:
    SERVICE_PORT: "8501"
  before_script:
    - apk add --no-cache bash curl
  script:
    - echo "Restarting deployment to pull new image..."
    - kubectl rollout restart deployment/${DEPLOYMENT} -n ${NAMESPACE}

    - echo "Waiting for rollout to complete..."
    - kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=180s

    - echo "Waiting for Streamlit to be ready..."
    - |
      SERVICE_URL="http://${SERVICE_HOST}:${SERVICE_PORT}"
      for i in $(seq 1 30); do
        HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/_stcore/health" || echo "000")
        if [ "$HEALTH" = "200" ]; then
          echo "Streamlit health check passed!"
          break
        fi
        echo "Health check attempt $i: HTTP $HEALTH, waiting..."
        sleep 5
      done
      if [ "$HEALTH" != "200" ]; then
        echo "Health check failed after 30 attempts"
        exit 1
      fi

    - echo "Verifying main page loads..."
    - |
      # Check that main page returns 200
      PAGE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/" || echo "000")
      if [ "$PAGE" != "200" ]; then
        echo "Main page failed: HTTP $PAGE"
        exit 1
      fi
      echo "Main page: OK"
      echo "All checks passed!"

# Deploy-test for dev
deploy-test-dev:
  extends: .deploy-test
  resource_group: center-console-dev
  variables:
    DEPLOYMENT: "center-console-dev"
    NAMESPACE: "media-dev"
    SERVICE_HOST: "center-console-dev.media-dev.svc.cluster.local"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

# Deploy-test for stg
deploy-test-stg:
  extends: .deploy-test
  resource_group: center-console-stg
  variables:
    DEPLOYMENT: "center-console-stg"
    NAMESPACE: "media-stg"
    SERVICE_HOST: "center-console-stg.media-stg.svc.cluster.local"
  rules:
    - if: $CI_COMMIT_BRANCH == "stg"

# Deploy-test for prod
deploy-test-prod:
  extends: .deploy-test
  resource_group: center-console-prod
  variables:
    DEPLOYMENT: "center-console-prod"
    NAMESPACE: "media-prod"
    SERVICE_HOST: "center-console-prod.media-prod.svc.cluster.local"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
